import React, { useEffect, useState, useCallback } from 'react';
import './Tasks.css';
import TaskStats from '../components/TaskStats';
import TaskList from '../components/TaskList';
import TaskForm from '../components/TaskForm';
import TaskFilters from '../components/TaskFilters';
import { useAuth } from '../context/AuthContext';
import axios from 'axios';
import { Task } from '../types/Task';

// üîß D√©tection de l'environnement pour l'API
const isProduction = window.location.hostname.includes("render.com");
const API_URL = isProduction
  ? "https://taskify-backend-6dkg.onrender.com/api"
  : "http://localhost:5000/api";

const Tasks: React.FC = () => {
  const { token, isAuthenticated } = useAuth();
  const [tasks, setTasks] = useState<Task[]>([]);
  const [filteredTasks, setFilteredTasks] = useState<Task[]>([]);
  const [showTaskForm, setShowTaskForm] = useState(false);
  const [editingTask, setEditingTask] = useState<Task | null>(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [statusFilter, setStatusFilter] = useState('all');
  const [priorityFilter, setPriorityFilter] = useState('all');
  const [selectedDate, setSelectedDate] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [sortBy, setSortBy] = useState<'dueDate' | 'priority' | 'createdAt' | 'title'>('dueDate');
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('asc');

  // ‚úÖ Configuration axios avec token
  const getAxiosConfig = useCallback(() => ({
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    }
  }), [token]);

  //* ‚úÖ Fonction pour r√©cup√©rer les t√¢ches
  const fetchTasks = useCallback(async () => {
    if (!token || !isAuthenticated) {
      console.log("‚ùå Pas de token ou utilisateur non authentifi√©");
      return;
    }

    setLoading(true);
    setError(null);
    
    try {
      console.log("üîÑ Chargement des t√¢ches...");
      
      const response = await axios.get(`${API_URL}/tasks`, getAxiosConfig());
      
      console.log("‚úÖ T√¢ches r√©cup√©r√©es:", response.data);
      
      const tasksData = Array.isArray(response.data) ? response.data : [];
      setTasks(tasksData);
      setFilteredTasks(tasksData);
      
    } catch (err: any) {
      console.error("‚ùå Erreur lors du chargement des t√¢ches:", err);
      
      if (err.response?.status === 404) {
        setError("Route des t√¢ches non trouv√©e. V√©rifiez votre serveur.");
      } else if (err.response?.status === 401) {
        setError("Non autoris√©. Veuillez vous reconnecter.");
      } else {
        setError(err.response?.data?.message || "Erreur lors du chargement des t√¢ches");
      }
    } finally {
      setLoading(false);
    }
  }, [token, isAuthenticated, getAxiosConfig]);

  //* ‚úÖ Fonction pour filtrer et trier les t√¢ches
  const applyFiltersAndSort = useCallback(() => {
    let filtered = [...tasks];
    
    // Filtrage
    if (searchTerm) {
      filtered = filtered.filter(task =>
        task.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
        task.description.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }
    
    if (statusFilter !== 'all') {
      filtered = filtered.filter(task => task.status === statusFilter);
    }
    
    if (priorityFilter !== 'all') {
      filtered = filtered.filter(task => task.priority === priorityFilter);
    }
    
    if (selectedDate) {
      filtered = filtered.filter(task => task.dueDate.startsWith(selectedDate));
    }

    // Tri
    filtered.sort((a, b) => {
      let aValue: any, bValue: any;
      
      switch (sortBy) {
        case 'priority':
          const priorityOrder = { 'Haute': 3, 'Moyenne': 2, 'Faible': 1 };
          aValue = priorityOrder[a.priority as keyof typeof priorityOrder];
          bValue = priorityOrder[b.priority as keyof typeof priorityOrder];
          break;
        case 'dueDate':
          aValue = new Date(a.dueDate);
          bValue = new Date(b.dueDate);
          break;
        case 'title':
          aValue = a.title.toLowerCase();
          bValue = b.title.toLowerCase();
          break;
        default:
          return 0;
      }
      
      if (sortOrder === 'asc') {
        return aValue > bValue ? 1 : -1;
      } else {
        return aValue < bValue ? 1 : -1;
      }
    });    
    setFilteredTasks(filtered);
  }, [tasks, searchTerm, statusFilter, priorityFilter, selectedDate, sortBy, sortOrder]);

  // ‚úÖ Charger les t√¢ches au montage du composant
  useEffect(() => {
    if (isAuthenticated && token) {
      fetchTasks();
    }
  }, [isAuthenticated, token, fetchTasks]);

  // ‚úÖ Appliquer les filtres et le tri
  useEffect(() => {
    applyFiltersAndSort();
  }, [applyFiltersAndSort]);

  //* ‚úÖ Ajouter une nouvelle t√¢che
  const handleAddTask = async (taskData: Omit<Task, '_id'>) => {
    try {
      console.log("üîÑ Cr√©ation d'une nouvelle t√¢che...", taskData);
      
      const response = await axios.post(
        `${API_URL}/tasks`,
        taskData,
        getAxiosConfig()
      );
      
      const newTask = response.data;
      setTasks(prev => [...prev, newTask]);
      console.log("‚úÖ Nouvelle t√¢che cr√©√©e:", newTask);
      
    } catch (error: any) {
      console.error("‚ùå Erreur lors de la cr√©ation:", error);
      setError(error.response?.data?.message || "Erreur lors de la cr√©ation de la t√¢che");
    }
  };

  //* ‚úÖ Modifier une t√¢che
  const handleEditTask = async (taskId: string, updatedData: Partial<Task>) => {
    try {
      console.log("üîÑ Modification de la t√¢che...", { taskId, updatedData });
      
      const response = await axios.put(
        `${API_URL}/tasks/${taskId}`,
        updatedData,
        getAxiosConfig()
      );
      
      const updatedTask = response.data;
      setTasks(prev => prev.map(task => task._id === taskId ? updatedTask : task));
      console.log("‚úÖ T√¢che modifi√©e:", updatedTask);
      
    } catch (error: any) {
      console.error("‚ùå Erreur lors de la modification:", error);
      setError(error.response?.data?.message || "Erreur lors de la modification de la t√¢che");
    }
  };

  //* ‚úÖ Supprimer une t√¢che
  const handleDeleteTask = async (taskId: string) => {
    try {
      console.log("üîÑ Suppression de la t√¢che...", taskId);
      
      await axios.delete(`${API_URL}/tasks/${taskId}`, getAxiosConfig());
      
      setTasks(prev => prev.filter(task => task._id !== taskId));
      console.log("‚úÖ T√¢che supprim√©e:", taskId);
      
    } catch (error: any) {
      console.error("‚ùå Erreur lors de la suppression:", error);
      setError(error.response?.data?.message || "Erreur lors de la suppression de la t√¢che");
    }
  };

  //* ‚úÖ Changer le statut d'une t√¢che
  const handleToggleStatus = async (taskId: string, newStatus: Task["status"]) => {
    try {
      console.log("üîÑ Changement de statut...", { taskId, newStatus });
      
      const response = await axios.put(
        `${API_URL}/tasks/${taskId}`,
        { status: newStatus },
        getAxiosConfig()
      );
      
      const updatedTask = response.data;
      setTasks(prev => prev.map(task =>
        task._id === taskId ? updatedTask : task
      ));
      
      console.log("‚úÖ Statut mis √† jour:", updatedTask);
      
    } catch (error: any) {
      console.error("‚ùå Erreur lors de la mise √† jour du statut:", error);
      setError(error.response?.data?.message || "Erreur lors de la mise √† jour du statut");
    }
  };

  // ‚úÖ Gestion du formulaire de t√¢che
  const closeTaskForm = () => {
    setShowTaskForm(false);
    setEditingTask(null);
  };

  const handleEditClick = (task: Task) => {
    setEditingTask(task);
    setShowTaskForm(true);
  };

  // ‚úÖ Affichage conditionnel si pas authentifi√©
  if (!isAuthenticated) {
    return (
      <div className="tasks-container">
        <div className="auth-required">
          <h2>Connexion requise</h2>
          <p>Veuillez vous connecter pour acc√©der √† vos t√¢ches.</p>
        </div>
      </div>
    );
  }

  return (
    <div className="tasks-container">
      {/* ‚úÖ Section de bienvenue avec bouton align√© */}
      <div className="tasks-header">
        <div className="header-content">
          <h1 className="page-title">
            Mes T√¢ches
          </h1>
          <p className="page-description">
            G√©rer vos t√¢ches en toute s√©curit√© avec Taskify.
          </p>
        </div>
        
        <button 
          className="add-task-btn"
          onClick={() => setShowTaskForm(true)}
        >
          ‚ûï Ajouter une t√¢che
        </button>
      </div>

      {/* ‚úÖ Gestion des √©tats */}
      {loading && (
        <div className="loading-section">
          <p>üîÑ Chargement de vos t√¢ches...</p>
        </div>
      )}

      {error && (
        <div className="error-section">
          <p className="error-message">‚ùå {error}</p>
          <button onClick={() => {
            setError(null);
            fetchTasks();
          }} className="retry-btn">
            üîÑ R√©essayer
          </button>
        </div>
      )}

      {/* ‚úÖ Contenu principal */}
      {!loading && (
        <>
          <TaskStats tasks={tasks} />
          
          <TaskFilters
            searchTerm={searchTerm}
            onSearchChange={setSearchTerm}
            statusFilter={statusFilter}
            onStatusChange={setStatusFilter}
            priorityFilter={priorityFilter}
            onPriorityChange={setPriorityFilter}
            selectedDate={selectedDate}
            onDateChange={setSelectedDate}
          />

          {/* ‚úÖ Options de tri */}
          <div className="sort-controls">
            <div className="sort-group">
              <label htmlFor="sortBy">Trier par :</label>
              <select 
                id="sortBy"
                value={sortBy} 
                onChange={(e) => setSortBy(e.target.value as typeof sortBy)}
              >
                <option value="dueDate">üìÖ Date d'√©ch√©ance</option>
                <option value="priority">üî• Priorit√©</option>
                <option value="title">üìù Titre</option>
                <option value="createdAt">üïí Date de cr√©ation</option>
              </select>
            </div>
            
            <button 
              className="sort-order-btn"
              onClick={() => setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')}
            >
              {sortOrder === 'asc' ? '‚¨ÜÔ∏è Croissant' : '‚¨áÔ∏è D√©croissant'}
            </button>
          </div>
          
          <TaskList
            tasks={filteredTasks}
            onEdit={handleEditClick}
            onDelete={handleDeleteTask}
            onToggleStatus={handleToggleStatus}
          />
        </>
      )}

      {/* ‚úÖ Formulaire de t√¢che */}
      {showTaskForm && (
        <TaskForm
          task={editingTask}
          onClose={closeTaskForm}
          onTaskCreated={(newTask) => {
            handleAddTask(newTask);
            closeTaskForm();
          }}
          onTaskUpdated={(updatedTask) => {
            if (updatedTask._id) {
              handleEditTask(updatedTask._id, updatedTask);
              closeTaskForm();
            } else {
              console.error("‚ùå Erreur: _id manquant dans la t√¢che mise √† jour");
            }
          }}
        />
      )}
    </div>
  );
};
export default Tasks;
